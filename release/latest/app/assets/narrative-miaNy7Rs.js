import{u as ee}from"./data-BuiUnMz4.js";import{d as k,t as z,e as I,g as D,a as T,n as Q,q as V,P as E,h as te}from"./index-CF42LyZY.js";import{NARRATIVE_OBSERVATIONS as ne,DEFAULT_NARRATIVE_CONFIG as oe}from"./narrativeObservations-BCHgV7BK.js";function ge(){const o=ee(()=>k.config.get(1));return{config:o,updateConfig:async h=>{await k.config.update(1,h)},loading:o===void 0}}async function K(o,s){const h=await k.teamMembers.toArray(),y=new Map(h.map(u=>[u.full_name,u])),d=o?z(I(o)):null;let c=d?await k.timesheets.where("month").anyOf(d).toArray():await k.timesheets.toArray();if(s){const u=new Set(c.filter(r=>D(r.r_number)===s||r.r_number===s).map(r=>r.full_name));c=c.filter(r=>u.has(r.full_name))}if(c.length===0)return[];const g=new Map;for(const u of c){const r=g.get(u.full_name)??[];r.push(u),g.set(u.full_name,r)}const w=[];for(const[u,r]of g){const l=y.get(u);if(!l)continue;const m=new Map,_=new Map;for(const a of r){const p=m.get(a.date)??new Set;a.r_number&&p.add(a.r_number),m.set(a.date,p),a.r_number&&_.set(a.r_number,(_.get(a.r_number)??0)+a.hours)}const f=m.size;if(f===0)continue;const M=[...m.values()].map(a=>a.size),P=M.reduce((a,p)=>a+p,0)/f,v=Math.max(...M),S=M.filter(a=>a>3).length,O=Math.min(100,Math.round(100/P)),b=new Set(r.map(a=>a.r_number).filter(Boolean)).size;let $="",C=0;const j=r.reduce((a,p)=>a+p.hours,0);for(const[a,p]of _)p>C&&($=a,C=p);const F=j>0?C/j:0;w.push({person:u,role:l.role,workDays:f,avgProjectsPerDay:Math.round(P*10)/10,maxProjectsInOneDay:v,highFragDays:S,focusScore:O,monthlyProjectCount:b,topProject:$,topProjectPct:F})}return w.sort((u,r)=>u.focusScore-r.focusScore),w}async function G(o,s){const h=await k.projects.toArray(),y=new Map(h.map(r=>[r.project_id,r])),d=o?z(I(o)):null;let c=d?await k.timesheets.where("month").anyOf(d).toArray():await k.timesheets.toArray();if(s&&(c=c.filter(r=>D(r.r_number)===s||r.r_number===s)),c.length===0)return[];const g=new Map;for(const r of c){if(!r.r_number)continue;const l=g.get(r.r_number)??new Map;l.set(r.full_name,(l.get(r.full_name)??0)+r.hours),g.set(r.r_number,l)}const w=[];for(const[r,l]of g){const m=[...l.values()].reduce(($,C)=>$+C,0);if(m<=5)continue;const _=[...l.entries()].map(([$,C])=>({person:$,hours:C,pct:C/m})).sort(($,C)=>C.hours-$.hours);let f=0,M=0;for(const $ of _)if(f+=$.pct,M++,f>.5)break;const P=y.get(r),v=P?.type??T.Admin,S=_[0]?.person??"",O=_[0]?.pct??0;let b="low";M===1&&m>20&&v===T.NPD?b="critical":M===1&&m>10?b="high":M<=2&&O>.7&&(b="medium"),w.push({projectId:r,projectName:P?.project_name??r,projectType:v,totalHours:Math.round(m*10)/10,contributorCount:_.length,busFactor:M,topContributor:S,topContributorPct:O,riskLevel:b,contributors:_})}const u={critical:0,high:1,medium:2,low:3};return w.sort((r,l)=>u[r.riskLevel]-u[l.riskLevel]||l.totalHours-r.totalHours),w}async function re(o,s){const h=await k.teamMembers.toArray(),y=new Map(h.map(u=>[u.full_name,u])),d=o?z(I(o)):null;let c=d?await k.timesheets.where("month").anyOf(d).toArray():await k.timesheets.toArray();if(s){const u=new Set(c.filter(r=>D(r.r_number)===s||r.r_number===s).map(r=>r.full_name));c=c.filter(r=>u.has(r.full_name))}if(c.length===0)return[];const g=new Map;for(const u of c){const r=g.get(u.full_name)??[];r.push(u),g.set(u.full_name,r)}const w=[];for(const[u,r]of g){const l=y.get(u);if(!l)continue;let m=0,_=0,f=0,M=0;for(const v of r)m+=v.hours,v.task?.toLowerCase().includes("meeting")??!1?_+=v.hours:v.r_number==="R0999"?M+=v.hours:v.r_number==="R0996"&&(f+=v.hours);const P=m-_-f-M;w.push({person:u,role:l.role,totalHours:Math.round(m*10)/10,meetingHours:Math.round(_*10)/10,meetingPct:m>0?_/m:0,adminHours:Math.round(f*10)/10,oooHours:Math.round(M*10)/10,productiveHours:Math.round(P*10)/10})}return w.sort((u,r)=>r.meetingPct-u.meetingPct),w}async function me(o,s){return s?ie(o,s):se(o)}async function X(o,s){const h=await k.narrativeConfig.get(1)??oe,y=await k.config.get(1),d=y?.std_monthly_capacity_hours??140,c=V(o);let g=await k.timesheets.where("month").equals(c).toArray();s&&(g=g.filter(f=>f.r_number===s||D(f.r_number)===s));const w=await k.teamMembers.toArray(),u=new Set(w.filter(f=>f.role===E.Engineer).map(f=>f.full_name)),r=new Set(w.filter(f=>f.role===E.LabTechnician).map(f=>f.full_name)),l=await k.projects.toArray(),m=new Map(l.map(f=>[f.project_id,f]));return{kpi:await te(o,s),timesheets:g,projects:m,teamMembers:w,engineerSet:u,labTechSet:r,config:y,narrativeConfig:h,capacity:d}}async function se(o){const s=await X(o);if(s.timesheets.length===0)return{paragraph:"No timesheet data available for this month.",highlights:[]};const{kpi:h,timesheets:y,projects:d,narrativeConfig:c,engineerSet:g,labTechSet:w,capacity:u}=s,{nameIndividuals:r,includeSpecificNumbers:l,includeTrendComparisons:m}=c,_=Z(o),f=new Map,M=new Set;let P=0;const v=new Set;for(const e of y)if(g.has(e.full_name)){f.set(e.full_name,(f.get(e.full_name)??0)+e.hours);const t=d.get(e.r_number);e.r_number&&t?.type!==T.Admin&&t?.type!==T.OutOfOffice&&M.add(e.r_number)}else w.has(e.full_name)&&(P+=e.hours,e.r_number&&v.add(e.r_number));const S=new Map(s.teamMembers.map(e=>[e.full_name,e])),O=[],b=[];for(const[e,t]of f){const n=(S.get(e)?.capacity_override_hours??0)>0?S.get(e).capacity_override_hours:u;t>n*1.15?O.push(e):t<n*.6&&b.push(e)}let $=null,C=null;if(m){const e=le(o),t=V(e),n=await k.timesheets.where("month").equals(t).toArray();if(n.length>0){let i=0,L=0,N=0;for(const A of n){if(!g.has(A.full_name))continue;const U=d.get(A.r_number);U?.type!==T.Admin&&U?.type!==T.OutOfOffice&&(i+=A.hours,U?.work_class==="Unplanned/Firefighting"&&(L+=A.hours)),A.task?.toLowerCase().includes("meeting")&&(N+=A.hours)}i>0&&($=L/i,C=N/i)}}const j=[];if(c.observations.firefightingLoad&&h.firefightingLoad>.1){const e=Math.round(h.firefightingLoad*100),t=J(e,$!==null?Math.round($*100):null,m,"%");let n;l?n=`unplanned firefighting reached ${e}%${t}`:n="unplanned firefighting exceeded the target level",j.push({key:"firefightingLoad",sentence:n,highlight:`Firefighting: ${e}%`})}if(c.observations.busFactorRisks){const t=(await G(o)).filter(n=>n.riskLevel==="critical"||n.riskLevel==="high");if(t.length>0){let n;if(l&&r){const i=t.slice(0,2).map(N=>N.projectId),L=t.length>2?` and ${t.length-2} more`:"";n=`${t.length} project${t.length!==1?"s":""} — ${i.join(", ")}${L} — ${t.length!==1?"have":"has"} single-point-of-failure risk with only one engineer contributing`}else l?n=`${t.length} project${t.length!==1?"s have":" has"} single-point-of-failure risk with insufficient contributor diversity`:n="several projects have single-point-of-failure risk with insufficient contributor diversity";j.push({key:"busFactorRisks",sentence:n,highlight:`Bus factor risk: ${t.length} project${t.length!==1?"s":""}`})}}if(c.observations.focusFragmentation){const t=(await K(o)).filter(n=>n.focusScore<35);if(t.length>0){const n=t[0];let i;r&&l?i=`${n.person} shows significant context fragmentation, averaging ${n.avgProjectsPerDay.toFixed(1)} projects per day across ${n.monthlyProjectCount} different work streams`:r?i=`${n.person} shows significant context fragmentation across a large number of work streams`:l?i=`one engineer shows significant context fragmentation, averaging ${n.avgProjectsPerDay.toFixed(1)} projects per day across ${n.monthlyProjectCount} work streams`:i="one engineer shows significant context fragmentation across a large number of work streams",j.push({key:"focusFragmentation",sentence:i,highlight:`Fragmented: ${t.length} engineer${t.length!==1?"s":""}`})}}if(c.observations.overtimeIndicators){const e=[],t=new Map;for(const n of y){if(!g.has(n.full_name))continue;const i=t.get(n.full_name)??[];i.push(n),t.set(n.full_name,i)}for(const[n,i]of t){const L=new Map;for(const A of i)L.set(A.date,(L.get(A.date)??0)+A.hours);const N=[...L.values()].filter(A=>A>8).length;N>=3&&e.push({name:n,days:N})}if(e.length>0){const n=e[0];let i;r&&l?i=`${n.name} logged overtime on ${n.days} days this month, which may indicate unsustainable workload`:r?i=`${n.name} logged overtime on multiple days, which may indicate unsustainable workload`:l?i=`a team member logged overtime on ${n.days} days this month, which may indicate unsustainable workload`:i="a team member logged overtime on multiple days, which may indicate unsustainable workload",j.push({key:"overtimeIndicators",sentence:i,highlight:`Overtime: ${e.length} engineer${e.length!==1?"s":""}`})}}if(c.observations.meetingTax){const t=(await re(o)).filter(n=>n.meetingPct>.15);if(t.length>0){const n=t[0],i=J(Math.round(n.meetingPct*100),C!==null?Math.round(C*100):null,m,"%");let L;r&&l?L=`${n.person} spent ${Math.round(n.meetingPct*100)}% of capacity in meetings, leaving limited time for engineering work${i}`:r?L=`${n.person} spent a disproportionate amount of time in meetings`:l?L=`one engineer spent ${Math.round(n.meetingPct*100)}% of capacity in meetings${i}`:L="one engineer spent a disproportionate amount of time in meetings",j.push({key:"meetingTax",sentence:L,highlight:`Meeting-heavy: ${t.length} engineer${t.length!==1?"s":""}`})}}if(c.observations.projectOverBurn||c.observations.projectUnderBurn){const e=await Q(o);if(c.observations.projectOverBurn){const t=e.filter(n=>n.planned_hours>0&&n.delta_pct>.3);if(t.length>0){const n=t[0];let i;r&&l?i=`${n.project_name} is over-burning at ${Math.round((1+n.delta_pct)*100)}% of planned hours`:l?i=`${t.length} project${t.length!==1?"s are":" is"} significantly over planned hours`:i=`${t.length>1?"some projects are":"a project is"} significantly over planned hours`,j.push({key:"projectOverBurn",sentence:i,highlight:`Over-burning: ${t.length} project${t.length!==1?"s":""}`})}}if(c.observations.projectUnderBurn){const t=e.filter(n=>n.planned_hours>0&&n.delta_pct<-.5);if(t.length>0){const n=t[0];let i;r&&l?i=`${n.project_name} is significantly under planned pace at ${Math.round((1+n.delta_pct)*100)}% of planned hours`:l?i=`${t.length} project${t.length!==1?"s are":" is"} significantly under planned pace`:i=`${t.length>1?"some projects are":"a project is"} significantly under planned pace`,j.push({key:"projectUnderBurn",sentence:i,highlight:`Under-burning: ${t.length} project${t.length!==1?"s":""}`})}}}if(c.observations.labTechContribution&&P>0){let e;l?e=`lab technicians contributed ${Math.round(P)} hours of support across ${v.size} project${v.size!==1?"s":""}`:e="lab technicians contributed additional support hours across several projects",j.push({key:"labTechContribution",sentence:e,highlight:`Lab tech support: ${Math.round(P)} hrs`})}const F=c.observationPriority;j.sort((e,t)=>{const n=F.indexOf(e.key),i=F.indexOf(t.key);return(n===-1?999:n)-(i===-1?999:i)});const a=j.slice(0,c.maxObservations),p=[],R=[];c.customOpening.trim()&&p.push(c.customOpening.trim()),p.push(`In ${_}, the team of ${h.activeEngineers} engineers logged ${Math.round(h.totalHoursLogged).toLocaleString()} hours across ${M.size} projects, achieving ${Math.round(h.teamUtilization*100)}% utilization.`);const x=h.npdFocus;let H=`Work was ${ce(x)} focused on NPD (${Math.round(x*100)}% of hours), with ${Math.round(h.sustainingHours)} hours on sustaining activities`;if(h.firefightingLoad>.1&&c.observations.firefightingLoad&&(H+=`, of which ${Math.round(h.firefightingLoad*100)}% was unplanned firefighting`),H+=".",p.push(H),a.length>0){const e=a.map((t,n)=>n===0?t.sentence.charAt(0).toUpperCase()+t.sentence.slice(1):t.sentence);p.push(e.join(". ")+"."),R.push(...a.map(t=>t.highlight))}if(b.length>0){if(r){const e=b.slice(0,3).join(", "),t=b.length>3?" and others":"";p.push(`${b.length} team member${b.length>1?"s have":" has"} available capacity below 60% utilization (${e}${t}).`)}else p.push(`${b.length} team member${b.length>1?"s have":" has"} available capacity (below 60% utilization).`);R.push(`Available capacity: ${b.join(", ")}`)}else h.teamUtilization>1&&(r&&O.length>0?p.push(`The team is running above full capacity with no slack available, with ${O.slice(0,2).join(" and ")} logging the most hours over capacity.`):p.push("The team is running above full capacity with no slack available."),R.push("No slack capacity"));return c.customClosing.trim()&&p.push(c.customClosing.trim()),{paragraph:p.join(" "),highlights:R}}async function ie(o,s){const h=await X(o,s),{kpi:y,timesheets:d,projects:c,narrativeConfig:g,engineerSet:w}=h,u=Z(o),r=c.get(s),l=r?.project_name??s,m=r?.type??T.Admin,_=r?.work_class??"Planned";if(d.length===0){const e=W(m);return{paragraph:`${l} (${s}) had no recorded activity in ${u}.`,highlights:[`${e} project`,"No activity"]}}const f=y.totalHoursLogged,M=new Map,P=new Map;for(const e of d)w.has(e.full_name)&&M.set(e.full_name,(M.get(e.full_name)??0)+e.hours),e.activity&&P.set(e.activity,(P.get(e.activity)??0)+e.hours);const v=new Map;for(const e of d)v.set(e.full_name,(v.get(e.full_name)??0)+e.hours);const S=[...v.entries()].sort((e,t)=>t[1]-e[1]).map(([e])=>e),O=S.length,b=[],$=[],C=W(m),j=[...P.entries()].sort((e,t)=>t[1]-e[1]);if(j.length===1){const e=j[0][0].toLowerCase();b.push(`${l} (${s}) logged ${Math.round(f)} hours of ${e} in ${u}${O===1?`, with ${S[0]} as the sole contributor`:` across ${O} contributors: ${q(S)}`}.`)}else b.push(`${l} (${s}) logged ${Math.round(f)} hours in ${u} across ${O} contributor${O!==1?"s":""}: ${q(S)}.`),b.push(`Work was split between ${ae(j)}.`);const a=(await Q(o)).find(e=>e.project_id===s||e.project_id===D(s));if(a&&a.planned_hours>0){const e=Math.round(a.actual_hours/a.planned_hours*100),t=ue(e);b.push(`This represents ${e}% of the ${Math.round(a.planned_hours)}h planned for the month${t}.`),$.push(`On plan: ${e}%`)}const p=[],R=ne.filter(e=>e.modes.includes("project")),x=new Set(R.map(e=>e.key));if(g.observations.busFactorRisks&&x.has("busFactorRisks")){const t=(await G(o,s)).find(n=>n.projectId===s||D(n.projectId)===s);if(t&&(t.riskLevel==="critical"||t.riskLevel==="high")){const n=t.topContributor,i=Math.round(t.topContributorPct*100);p.push({key:"busFactorRisks",sentence:`This project depends on a single contributor (${n}), creating key-person risk — ${n} accounted for ${i}% of all hours`,highlight:`Single contributor: ${n}`})}}if(g.observations.focusFragmentation&&x.has("focusFragmentation")&&S.length>0){const e=await K(o),t=S[0],n=e.find(i=>i.person===t);if(n&&n.monthlyProjectCount>3){const i=n.monthlyProjectCount-1;i>2&&p.push({key:"focusFragmentation",sentence:`${t}, the primary contributor, is also active on ${i} other projects this month, which may affect throughput`,highlight:`${t}: ${n.monthlyProjectCount} projects`})}}if(g.observations.projectOverBurn&&x.has("projectOverBurn")&&a&&a.planned_hours>0&&a.delta_pct>.3){const e=Math.round(a.delta_pct*100);p.push({key:"projectOverBurn",sentence:`Hours are running ${e}% above plan — ${Math.round(a.actual_hours)}h logged against ${Math.round(a.planned_hours)}h planned`,highlight:`Over plan: ${Math.round((1+a.delta_pct)*100)}%`})}if(g.observations.projectUnderBurn&&x.has("projectUnderBurn")&&a&&a.planned_hours>0&&a.delta_pct<-.5){const e=Math.round(a.actual_hours/a.planned_hours*100);p.push({key:"projectUnderBurn",sentence:`Only ${e}% of planned hours have been logged — ${Math.round(a.actual_hours)}h of ${Math.round(a.planned_hours)}h`,highlight:`Under plan: ${e}%`})}_==="Unplanned/Firefighting"&&(b.push("This project is classified as unplanned firefighting work."),$.push("Unplanned/Firefighting"));const B=g.observationPriority;p.sort((e,t)=>{const n=B.indexOf(e.key),i=B.indexOf(t.key);return(n===-1?999:n)-(i===-1?999:i)});const H=p.slice(0,g.maxObservations);if(H.length>0){const e=H.map((t,n)=>n===0?t.sentence.charAt(0).toUpperCase()+t.sentence.slice(1):t.sentence);b.push(e.join(". ")+"."),$.push(...H.map(t=>t.highlight))}return $.push(`${C} project`),O>1&&$.push(`${O} contributors`),{paragraph:b.join(" "),highlights:$}}function ae(o){const s=o.map(([h,y])=>`${h.toLowerCase()} (${Math.round(y)}h)`);return Y(s)}function q(o){if(o.length<=3)return Y(o);const s=o.slice(0,3),h=o.length-3;return`${s.join(", ")}, and ${h} other${h!==1?"s":""}`}function Y(o){return o.length===0?"":o.length===1?o[0]:o.length===2?`${o[0]} and ${o[1]}`:`${o.slice(0,-1).join(", ")}, and ${o[o.length-1]}`}function ce(o){return o>.6?"strongly":o>.4?"moderately":"lightly"}function ue(o){return o>=90&&o<=110?", tracking close to plan":o>130?", significantly exceeding the planned budget":o>110?", slightly over plan":o<50?", well below planned pace":o<90?", slightly under plan":""}function W(o){return o===T.NPD?"NPD":o===T.Sustaining?"Sustaining":o===T.Sprint?"Sprint":String(o)}function Z(o){const[s,h]=o.split("-");return`${["January","February","March","April","May","June","July","August","September","October","November","December"][parseInt(h)-1]} ${s}`}function le(o){const[s,h]=o.split("-");let y=parseInt(s),d=parseInt(h)-1;return d===0&&(d=12,y-=1),`${y}-${String(d).padStart(2,"0")}`}function J(o,s,h,y){if(!h||s===null)return"";const d=o-s;return Math.abs(d)<1?"":d>0?`, up from ${s}${y} last month`:`, down from ${s}${y} last month`}export{G as a,re as b,K as c,me as g,ge as u};
