import{j as e,r as H,P as E,d as b,a as R,W as Y,f as U,D as q,K,b as O,c as Q}from"./index-CF42LyZY.js";import{r as k,R as J,i as X}from"./vendor-B7kh90xw.js";import{u as Z,g as ee}from"./narrative-miaNy7Rs.js";import{u as S}from"./data-BuiUnMz4.js";import{ANOMALY_RULES as I,getDefaultThresholdsForRule as L}from"./anomalyRules-sVyOhB1E.js";import{DEFAULT_NARRATIVE_CONFIG as te,NARRATIVE_OBSERVATIONS as re}from"./narrativeObservations-BCHgV7BK.js";function ae(){const{config:i,updateConfig:g,loading:N}=Z(),[j,n]=k.useState(""),o=async(r,m)=>{try{await g({[r]:m}),(r==="std_monthly_capacity_hours"||r==="over_utilization_threshold_pct")&&H(),n("Saved"),setTimeout(()=>n(""),2e3)}catch(c){console.error("Failed to save:",c),n("Error saving")}};return N||!i?e.jsx("div",{className:"p-4 text-[var(--text-muted)]",children:"Loading..."}):e.jsxs("div",{className:"max-w-xl space-y-5",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-[13px] font-medium text-[var(--text-secondary)] mb-1.5",children:"Team Name"}),e.jsx("input",{type:"text",value:i.team_name,onChange:r=>o("team_name",r.target.value),onBlur:r=>o("team_name",r.target.value),className:"w-full text-[13px] px-3 py-2 border border-[var(--border-input)] rounded-md bg-[var(--bg-input)] text-[var(--text-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-focus-ring)]",placeholder:"e.g., ENG_Fire Suppression"}),e.jsx("p",{className:"text-[11px] text-[var(--text-muted)] mt-1.5",children:"Auto-filled from first CSV import"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-[13px] font-medium text-[var(--text-secondary)] mb-1.5",children:"Standard Monthly Capacity (hours)"}),e.jsx("input",{type:"number",value:i.std_monthly_capacity_hours,onChange:r=>o("std_monthly_capacity_hours",parseFloat(r.target.value)),onBlur:r=>o("std_monthly_capacity_hours",parseFloat(r.target.value)),className:"w-full text-[13px] px-3 py-2 border border-[var(--border-input)] rounded-md bg-[var(--bg-input)] text-[var(--text-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-focus-ring)]",min:"0",step:"1"}),e.jsx("p",{className:"text-[11px] text-[var(--text-muted)] mt-1.5",children:"Base working hours per person per month (used to calculate utilization)"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-[13px] font-medium text-[var(--text-secondary)] mb-1.5",children:"Over-Utilization Threshold (%)"}),e.jsx("input",{type:"number",value:i.over_utilization_threshold_pct*100,onChange:r=>o("over_utilization_threshold_pct",parseFloat(r.target.value)/100),onBlur:r=>o("over_utilization_threshold_pct",parseFloat(r.target.value)/100),className:"w-full text-[13px] px-3 py-2 border border-[var(--border-input)] rounded-md bg-[var(--bg-input)] text-[var(--text-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-focus-ring)]",min:"0",step:"1"}),e.jsx("p",{className:"text-[11px] text-[var(--text-muted)] mt-1.5",children:"Engineers above this percentage are flagged as over-utilized"})]}),j&&e.jsx("div",{className:`text-sm font-medium ${j==="Saved"?"text-[var(--status-good)]":"text-[var(--status-danger)]"}`,children:j})]})}function se(){const i=S(()=>b.teamMembers.toArray()),g=async(n,o)=>{await b.teamMembers.update(n,o),("role"in o||"capacity_override_hours"in o)&&H()},N=async n=>{await b.teamMembers.add(n)};return{teamMembers:i?[...i].sort((n,o)=>n.role!==o.role?n.role===E.Engineer?-1:1:n.full_name.localeCompare(o.full_name)):[],updateMember:g,addMember:N,loading:i===void 0}}function ne(){const{teamMembers:i,updateMember:g,addMember:N,loading:j}=se(),[n,o]=k.useState(!1),[r,m]=k.useState({person_id:0,person:"",full_name:"",role:E.Engineer,capacity_override_hours:0}),c=S(async()=>{const h=await b.timesheets.toArray(),y=new Map;for(const v of h){const a=y.get(v.full_name)??0;y.set(v.full_name,a+v.hours)}return y}),u=(h,y)=>{g(h,{role:y})},p=(h,y)=>{g(h,{capacity_override_hours:y})},f=async()=>{if(!r.full_name){alert("Full name is required");return}const h=Date.now()+Math.floor(Math.random()*1e3);await N({...r,person_id:h,person:r.full_name.replace(/\s+/g,"")}),m({person_id:0,person:"",full_name:"",role:E.Engineer,capacity_override_hours:0}),o(!1)};return j?e.jsx("div",{className:"p-4 text-[var(--text-muted)]",children:"Loading..."}):e.jsxs("div",{className:"space-y-5",children:[e.jsx("div",{className:"flex items-center justify-end",children:e.jsx("button",{onClick:()=>o(!n),className:"text-[13px] font-medium px-4 py-2 rounded-md text-white bg-[var(--accent)] hover:bg-[var(--accent-hover)]",children:n?"Cancel":"Add Member"})}),n&&e.jsxs("div",{className:"bg-[var(--accent-light)] border border-[var(--border-default)] rounded-lg p-4 space-y-4",children:[e.jsx("h3",{className:"font-medium text-[var(--text-primary)]",children:"Add New Team Member"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-[13px] font-medium text-[var(--text-secondary)] mb-1.5",children:"Full Name *"}),e.jsx("input",{type:"text",value:r.full_name,onChange:h=>m({...r,full_name:h.target.value}),className:"w-full text-[13px] px-3 py-2 border border-[var(--border-input)] rounded-md bg-[var(--bg-input)] text-[var(--text-primary)]",placeholder:"e.g., Justin Anderson"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-[13px] font-medium text-[var(--text-secondary)] mb-1.5",children:"Role"}),e.jsxs("select",{value:r.role,onChange:h=>m({...r,role:h.target.value}),className:"w-full text-[13px] px-3 py-2 border border-[var(--border-input)] rounded-md bg-[var(--bg-input)] text-[var(--text-primary)]",children:[e.jsx("option",{value:E.Engineer,children:"Engineer"}),e.jsx("option",{value:E.LabTechnician,children:"Lab Technician"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-[13px] font-medium text-[var(--text-secondary)] mb-1.5",children:"Capacity Override (0 = default)"}),e.jsx("input",{type:"number",value:r.capacity_override_hours,onChange:h=>m({...r,capacity_override_hours:parseFloat(h.target.value)}),className:"w-full text-[13px] px-3 py-2 border border-[var(--border-input)] rounded-md bg-[var(--bg-input)] text-[var(--text-primary)]",min:"0"})]})]}),e.jsx("button",{onClick:f,className:"text-[13px] font-medium px-4 py-2 rounded-md text-white bg-[var(--accent)] hover:bg-[var(--accent-hover)]",children:"Add Member"})]}),e.jsx("div",{className:"rounded-lg border border-[var(--border-default)] overflow-hidden",children:e.jsxs("table",{className:"min-w-full divide-y divide-[var(--border-default)]",children:[e.jsx("thead",{className:"bg-[var(--bg-table-header)]",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-[11px] font-medium text-[var(--text-muted)] uppercase tracking-[0.05em]",children:"Name"}),e.jsx("th",{className:"px-6 py-3 text-left text-[11px] font-medium text-[var(--text-muted)] uppercase tracking-[0.05em]",children:"Role"}),e.jsx("th",{className:"px-6 py-3 text-left text-[11px] font-medium text-[var(--text-muted)] uppercase tracking-[0.05em]",children:"Capacity Override (hrs)"}),e.jsx("th",{className:"px-6 py-3 text-left text-[11px] font-medium text-[var(--text-muted)] uppercase tracking-[0.05em]",children:"Total Hours (all time)"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-[var(--border-subtle)]",children:i.map(h=>e.jsxs("tr",{className:"hover:bg-[var(--bg-table-hover)]",children:[e.jsx("td",{className:"px-6 py-4 text-[13px] font-medium text-[var(--text-primary)]",children:h.full_name}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("select",{value:h.role,onChange:y=>u(h.person_id,y.target.value),className:"text-[13px] px-2 py-1 border border-[var(--border-input)] rounded bg-[var(--bg-input)] text-[var(--text-primary)]",children:[e.jsx("option",{value:E.Engineer,children:"Engineer"}),e.jsx("option",{value:E.LabTechnician,children:"Lab Technician"})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("input",{type:"number",value:h.capacity_override_hours,onChange:y=>p(h.person_id,parseFloat(y.target.value)),className:"w-24 text-[13px] px-2 py-1 border border-[var(--border-input)] rounded bg-[var(--bg-input)] text-[var(--text-primary)]",min:"0"})}),e.jsx("td",{className:"px-6 py-4 text-[13px] text-[var(--text-secondary)]",children:c?.get(h.full_name)?.toFixed(1)??"0.0"})]},h.person_id))})]})}),i.length===0&&e.jsx("div",{className:"text-center py-12 text-[var(--text-muted)]",children:"No team members found. Import CSV data to populate automatically, or add members manually."})]})}function le(){const i=S(()=>b.projects.toArray());return{projects:i??[],updateProject:async(o,r)=>{await b.projects.update(o,r),("type"in r||"work_class"in r)&&H()},addProject:async o=>{await b.projects.add(o)},getProject:async o=>await b.projects.get(o),getProjectsByType:o=>i?.filter(r=>r.type===o)??[],loading:i===void 0}}function oe(i){const g=S(()=>i?b.projectSkillRequirements.where("project_id").equals(i).toArray():b.projectSkillRequirements.toArray(),[i]);return{requirements:g??[],setRequirements:async(j,n)=>{await b.projectSkillRequirements.where("project_id").equals(j).delete(),n.length>0&&await b.projectSkillRequirements.bulkAdd(n.map(o=>({project_id:j,skill:o.skill,weight:o.weight})))},loading:g===void 0}}function ie({projectId:i,projectName:g,isOpen:N,onClose:j}){const n=S(()=>b.skillCategories.orderBy("sort_order").toArray()),{requirements:o,setRequirements:r}=oe(i),[m,c]=k.useState([]),[u,p]=k.useState(!1);if(k.useEffect(()=>{if(!n||!N)return;const a=new Map(o.map(t=>[t.skill,t.weight]));c(n.map(t=>({skill:t.name,enabled:a.has(t.name),weight:a.get(t.name)??3})))},[n,o,N]),!N)return null;const f=a=>{c(t=>t.map(l=>l.skill===a?{...l,enabled:!l.enabled}:l))},h=(a,t)=>{c(l=>l.map(d=>d.skill===a?{...d,weight:t}:d))},y=async()=>{p(!0);const a=m.filter(t=>t.enabled).map(t=>({skill:t.skill,weight:t.weight}));await r(i,a),p(!1),j()},v=m.filter(a=>a.enabled).length;return e.jsx("div",{className:"fixed inset-0 z-50 overflow-y-auto",children:e.jsxs("div",{className:"flex items-center justify-center min-h-screen px-4",children:[e.jsx("div",{className:"fixed inset-0 bg-black/40 transition-opacity",onClick:j}),e.jsxs("div",{className:"relative bg-[var(--bg-panel)] border border-[var(--border-default)] rounded-xl shadow-xl max-w-md w-full p-6 z-10",children:[e.jsx("h3",{className:"text-[15px] font-semibold text-[var(--text-primary)] mb-1",children:"Required Skills"}),e.jsxs("p",{className:"text-[12px] text-[var(--text-muted)] mb-4",children:[i," — ",g||"Untitled"]}),e.jsx("div",{className:"max-h-[400px] overflow-y-auto space-y-1",children:m.map(a=>e.jsxs("div",{className:`flex items-center gap-3 px-3 py-2 rounded-lg transition-colors ${a.enabled?"bg-[var(--accent-subtle,rgba(37,99,235,0.06))]":"hover:bg-[var(--bg-table-hover)]"}`,children:[e.jsx("input",{type:"checkbox",checked:a.enabled,onChange:()=>f(a.skill),className:"w-4 h-4 rounded border-[var(--border-input)] accent-[var(--accent)]"}),e.jsx("span",{className:`flex-1 text-[13px] ${a.enabled?"text-[var(--text-primary)] font-medium":"text-[var(--text-secondary)]"}`,children:a.skill}),a.enabled&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-[11px] text-[var(--text-muted)]",children:"Weight:"}),e.jsx("select",{value:a.weight,onChange:t=>h(a.skill,parseInt(t.target.value)),className:"text-[12px] px-1.5 py-0.5 border border-[var(--border-input)] rounded bg-[var(--bg-input)] text-[var(--text-primary)]",children:[1,2,3,4,5].map(t=>e.jsx("option",{value:t,children:t},t))})]})]},a.skill))}),e.jsxs("div",{className:"flex items-center justify-between mt-5 pt-4 border-t border-[var(--border-subtle)]",children:[e.jsxs("span",{className:"text-[12px] text-[var(--text-muted)]",children:[v," skill",v!==1?"s":""," selected"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:j,className:"px-4 py-1.5 text-[13px] font-medium text-[var(--text-secondary)] bg-[var(--bg-table-header)] rounded-lg hover:bg-[var(--bg-table-hover)]",children:"Cancel"}),e.jsx("button",{onClick:y,disabled:u,className:"px-4 py-1.5 text-[13px] font-medium text-white bg-[var(--accent)] rounded-lg hover:opacity-90 disabled:opacity-50",children:u?"Saving...":"Save"})]})]})]})]})})}function de(){const{projects:i,updateProject:g,loading:N}=le(),j=S(()=>b.teamMembers.toArray())??[],[n,o]=k.useState(new Set([R.NPD,R.Sustaining,R.Admin,R.OutOfOffice,R.Sprint])),[r,m]=k.useState(null),[c,u]=k.useState(null),p=S(()=>b.projectSkillRequirements.toArray()),f=new Map;if(p)for(const a of p){const t=f.get(a.project_id)??[];t.push(a),f.set(a.project_id,t)}const h=a=>{const t=new Set(n);t.has(a)?t.delete(a):t.add(a),o(t)},y=i.filter(a=>n.has(a.type));if(N)return e.jsx("div",{className:"p-4 text-[var(--text-muted)]",children:"Loading..."});const v=r?i.find(a=>a.project_id===r):null;return e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-[13px] font-medium text-[var(--text-secondary)] mb-3",children:"Filter by Type"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:Object.values(R).map(a=>e.jsx("button",{onClick:()=>h(a),className:`px-3 py-1 text-[13px] font-medium rounded-md ${n.has(a)?"bg-[var(--accent)] text-white":"bg-[var(--bg-table-header)] text-[var(--text-secondary)] hover:bg-[var(--bg-table-hover)]"}`,children:a},a))})]}),e.jsx("div",{className:"rounded-lg border border-[var(--border-default)] overflow-hidden",children:e.jsxs("table",{className:"min-w-full divide-y divide-[var(--border-default)]",children:[e.jsx("thead",{className:"bg-[var(--bg-table-header)]",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-[11px] font-medium text-[var(--text-muted)] uppercase tracking-[0.05em]",children:"Project ID"}),e.jsx("th",{className:"px-6 py-3 text-left text-[11px] font-medium text-[var(--text-muted)] uppercase tracking-[0.05em]",children:"Project Name"}),e.jsx("th",{className:"px-6 py-3 text-left text-[11px] font-medium text-[var(--text-muted)] uppercase tracking-[0.05em]",children:"Type"}),e.jsx("th",{className:"px-6 py-3 text-left text-[11px] font-medium text-[var(--text-muted)] uppercase tracking-[0.05em]",children:"Work Class"}),e.jsx("th",{className:"px-6 py-3 text-left text-[11px] font-medium text-[var(--text-muted)] uppercase tracking-[0.05em]",children:"Required Skills"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-[var(--border-subtle)]",children:y.map(a=>{const t=f.get(a.project_id)??[];return e.jsxs(J.Fragment,{children:[e.jsxs("tr",{className:"hover:bg-[var(--bg-table-hover)]",children:[e.jsx("td",{className:"px-6 py-4 text-[13px] font-medium text-[var(--text-primary)]",children:e.jsxs("div",{className:"flex items-center gap-2",children:[a.project_id,e.jsxs("button",{onClick:()=>u(c===a.project_id?null:a.project_id),className:"text-[10px] text-[var(--accent)] hover:underline",title:"Toggle extended details",children:[c===a.project_id?"▾":"▸"," details"]})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("input",{type:"text",value:a.project_name,onChange:l=>g(a.project_id,{project_name:l.target.value}),className:"w-full text-[13px] px-2 py-1 border border-[var(--border-input)] rounded bg-[var(--bg-input)] text-[var(--text-primary)]"})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("select",{value:a.type,onChange:l=>g(a.project_id,{type:l.target.value}),className:"text-[13px] px-2 py-1 border border-[var(--border-input)] rounded bg-[var(--bg-input)] text-[var(--text-primary)]",children:Object.values(R).map(l=>e.jsx("option",{value:l,children:l},l))})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("select",{value:a.work_class,onChange:l=>g(a.project_id,{work_class:l.target.value}),className:"text-[13px] px-2 py-1 border border-[var(--border-input)] rounded bg-[var(--bg-input)] text-[var(--text-primary)]",children:Object.values(Y).map(l=>e.jsx("option",{value:l,children:l},l))})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("div",{className:"flex items-center gap-2 flex-wrap",children:t.length>0?e.jsxs(e.Fragment,{children:[t.sort((l,d)=>d.weight-l.weight).map(l=>e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 text-[11px] font-medium rounded-full bg-[var(--accent)] text-white",title:`${l.skill} — weight ${l.weight}`,children:[l.skill,e.jsxs("span",{className:"opacity-70",children:["×",l.weight]})]},l.skill)),e.jsx("button",{onClick:()=>m(a.project_id),className:"text-[11px] text-[var(--accent)] hover:underline font-medium",children:"Edit"})]}):e.jsx("button",{onClick:()=>m(a.project_id),className:"text-[12px] text-[var(--text-muted)] hover:text-[var(--accent)] hover:underline",children:"+ Add skills"})})})]}),c===a.project_id&&e.jsx("tr",{className:"bg-[var(--bg-table-header)]",children:e.jsx("td",{colSpan:5,className:"px-6 py-3",children:e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-[11px] font-medium text-[var(--text-muted)] uppercase mb-1",children:"Product Category"}),e.jsx("input",{type:"text",value:a.product_category??"",onChange:l=>g(a.project_id,{product_category:l.target.value||void 0}),placeholder:"e.g., Couplings, Valves",className:"w-full text-[12px] px-2 py-1 border border-[var(--border-input)] rounded bg-[var(--bg-input)] text-[var(--text-primary)]"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-[11px] font-medium text-[var(--text-muted)] uppercase mb-1",children:"Mendix Score (1-10)"}),e.jsx("input",{type:"number",min:1,max:10,value:a.mendix_score??"",onChange:l=>g(a.project_id,{mendix_score:l.target.value?parseInt(l.target.value):void 0}),className:"w-full text-[12px] px-2 py-1 border border-[var(--border-input)] rounded bg-[var(--bg-input)] text-[var(--text-primary)]"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-[11px] font-medium text-[var(--text-muted)] uppercase mb-1",children:"Assigned Engineer"}),e.jsxs("select",{value:a.assigned_engineer??"",onChange:l=>g(a.project_id,{assigned_engineer:l.target.value||void 0}),className:"w-full text-[12px] px-2 py-1 border border-[var(--border-input)] rounded bg-[var(--bg-input)] text-[var(--text-primary)]",children:[e.jsx("option",{value:"",children:"—"}),j.map(l=>e.jsx("option",{value:l.full_name,children:l.full_name},l.person_id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-[11px] font-medium text-[var(--text-muted)] uppercase mb-1",children:"Assigned Lab Tech"}),e.jsxs("select",{value:a.assigned_lab_tech??"",onChange:l=>g(a.project_id,{assigned_lab_tech:l.target.value||void 0}),className:"w-full text-[12px] px-2 py-1 border border-[var(--border-input)] rounded bg-[var(--bg-input)] text-[var(--text-primary)]",children:[e.jsx("option",{value:"",children:"—"}),j.map(l=>e.jsx("option",{value:l.full_name,children:l.full_name},l.person_id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-[11px] font-medium text-[var(--text-muted)] uppercase mb-1",children:"Est. Eng Hours"}),e.jsx("input",{type:"number",min:0,value:a.estimated_eng_hours??"",onChange:l=>g(a.project_id,{estimated_eng_hours:l.target.value?parseFloat(l.target.value):void 0}),className:"w-full text-[12px] px-2 py-1 border border-[var(--border-input)] rounded bg-[var(--bg-input)] text-[var(--text-primary)]"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-[11px] font-medium text-[var(--text-muted)] uppercase mb-1",children:"Est. Lab Hours"}),e.jsx("input",{type:"number",min:0,value:a.estimated_lab_hours??"",onChange:l=>g(a.project_id,{estimated_lab_hours:l.target.value?parseFloat(l.target.value):void 0}),className:"w-full text-[12px] px-2 py-1 border border-[var(--border-input)] rounded bg-[var(--bg-input)] text-[var(--text-primary)]"})]})]})})})]},a.project_id)})})]})}),y.length===0&&e.jsx("div",{className:"text-center py-12 text-[var(--text-muted)]",children:"No projects match the selected filters."}),r&&v&&e.jsx(ie,{projectId:r,projectName:v.project_name,isOpen:!0,onClose:()=>m(null)})]})}const W=["FEA","CFD","Deflector development","VicFlex hose","VicFlex bracket","Vortex design","Vortex operation","Data acquisition","Fire test protocols","Failure / root cause analysis","Statistical analysis","Test fixture design","Codes and standards","Tolerance stackup"];function ce(){const[i,g]=k.useState(!1),[N,j]=k.useState(""),n=S(()=>b.teamMembers.toArray()),o=S(()=>b.skills.toArray()),r=S(()=>b.skillCategories.toArray());if(k.useEffect(()=>{r&&r.length===0&&(async()=>{for(let l=0;l<W.length;l++)await b.skillCategories.add({name:W[l],sort_order:l})})()},[r]),!n||!o||!r)return e.jsx("div",{className:"p-4 text-[var(--text-muted)]",children:"Loading..."});const m=n.filter(t=>t.role===E.Engineer).sort((t,l)=>t.full_name.localeCompare(l.full_name));if(m.length===0)return e.jsx("div",{className:"space-y-5",children:e.jsx("div",{className:"bg-[var(--bg-table-header)] border border-[var(--border-default)] rounded-lg p-8 text-center",children:e.jsx("p",{className:"text-[var(--text-secondary)]",children:"Import timesheet data first to populate team members."})})});const c=r.sort((t,l)=>t.sort_order-l.sort_order),u=new Map;o.forEach(t=>{u.set(`${t.engineer}|${t.skill}`,t.rating)});const p=async(t,l)=>{const w=((u.get(`${t}|${l}`)||0)+1)%6,A=o.find(D=>D.engineer===t&&D.skill===l);A?await b.skills.update(A.id,{rating:w}):await b.skills.add({engineer:t,skill:l,rating:w})},f=t=>{switch(t){case 0:return"bg-[var(--bg-table-header)] text-[var(--text-muted)]";case 1:return"bg-amber-100 text-amber-800";case 2:return"bg-amber-200 text-amber-900";case 3:return"bg-green-100 text-green-800";case 4:return"bg-green-300 text-green-900";case 5:return"bg-green-600 text-white";default:return"bg-[var(--bg-table-header)] text-[var(--text-muted)]"}},h=t=>t===0?"—":t.toString(),y=async()=>{if(!N.trim())return;const t=c.length>0?Math.max(...c.map(l=>l.sort_order)):-1;await b.skillCategories.add({name:N.trim(),sort_order:t+1});for(const l of m)await b.skills.add({engineer:l.full_name,skill:N.trim(),rating:0});j(""),g(!1)},v=async t=>{const l=o.filter(d=>d.engineer===t).map(d=>d.id);l.length!==0&&await b.skills.bulkDelete(l)},a=async t=>{if(!confirm(`Remove '${t}' skill? This will delete all ratings for this skill.`))return;const l=o.filter(d=>d.skill===t).map(d=>d.id);await b.skills.bulkDelete(l),await b.skillCategories.where("name").equals(t).delete()};return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"overflow-auto border border-[var(--border-default)] rounded-lg",style:{maxHeight:"calc(100vh - 280px)"},children:e.jsxs("table",{className:"w-full border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"sticky left-0 z-30 border-b-2 border-r px-3 py-2 text-left text-[11px] font-semibold uppercase tracking-[0.05em]",style:{backgroundColor:"var(--bg-table-header)",borderColor:"var(--border-default)",color:"var(--text-muted)",minWidth:140},children:"Engineer"}),c.map(t=>e.jsxs("th",{className:"border-b-2 px-2 py-2 text-center text-[11px] font-medium group",style:{backgroundColor:"var(--bg-table-header)",borderColor:"var(--border-default)",color:"var(--text-secondary)",minWidth:80,position:"relative"},children:[t.name,e.jsx("button",{onClick:()=>a(t.name),className:"opacity-0 group-hover:opacity-100 transition-opacity",style:{position:"absolute",top:2,right:2,fontSize:13,lineHeight:1,padding:"0 2px",color:"var(--status-danger)"},title:`Remove "${t.name}"`,children:"×"})]},t.name)),e.jsx("th",{className:"border-b-2 px-2 py-2 text-center",style:{backgroundColor:"var(--bg-table-header)",borderColor:"var(--border-default)",minWidth:56},children:i?e.jsx("input",{type:"text",value:N,onChange:t=>j(t.target.value),onKeyDown:t=>t.key==="Enter"&&y(),onBlur:y,placeholder:"Skill name",className:"w-24 px-1.5 py-0.5 text-[11px] border rounded",style:{borderColor:"var(--border-input)",backgroundColor:"var(--bg-input)"},autoFocus:!0}):e.jsx("button",{onClick:()=>g(!0),style:{color:"var(--accent)",fontSize:11,fontWeight:600},title:"Add skill column",children:"+ Add"})})]})}),e.jsx("tbody",{children:m.map((t,l)=>{const d=l%2===0?"#ffffff":"var(--bg-table-header)";return e.jsxs("tr",{children:[e.jsx("td",{className:"sticky left-0 z-10 border-r border-b whitespace-nowrap text-[13px] font-medium group/row",style:{backgroundColor:d,borderColor:"var(--border-subtle)",color:"var(--text-primary)",padding:"4px 12px",boxShadow:"2px 0 4px -2px rgba(0,0,0,0.08)"},children:e.jsxs("span",{className:"flex items-center gap-1",children:[t.full_name,e.jsx("button",{onClick:()=>v(t.full_name),className:"opacity-0 group-hover/row:opacity-100 transition-opacity ml-auto text-[11px] px-1.5 py-0.5 rounded hover:bg-red-50",style:{color:"var(--status-danger)"},title:`Clear all skills for ${t.full_name}`,children:"Clear"})]})}),c.map(w=>{const A=u.get(`${t.full_name}|${w.name}`)||0;return e.jsx("td",{className:"border-b text-center",style:{borderColor:"var(--border-subtle)",padding:"3px 4px",backgroundColor:d},children:e.jsx("button",{onClick:()=>p(t.full_name,w.name),className:`
                            w-10 h-7 rounded text-xs font-semibold
                            ${f(A)}
                            hover:ring-2 hover:ring-[var(--accent)] hover:ring-offset-1
                            transition-all cursor-pointer
                          `,children:h(A)})},w.name)}),e.jsx("td",{className:"border-b",style:{borderColor:"var(--border-subtle)",padding:"3px 4px",backgroundColor:d}})]},t.person_id)})})]})}),e.jsxs("div",{className:"flex items-center justify-between text-[12px]",style:{color:"var(--text-muted)"},children:[e.jsxs("p",{children:[m.length," engineers × ",c.length," skills"]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"font-medium",style:{color:"var(--text-secondary)"},children:"Rating:"}),[0,1,2,3,4,5].map(t=>e.jsx("div",{className:`w-7 h-5 rounded flex items-center justify-center text-[10px] font-semibold ${f(t)}`,children:h(t)},t))]})]})]})}function xe(){const[i,g]=k.useState({}),N=S(()=>b.projects.where("type").equals(R.NPD).sortBy("project_id")),j=S(()=>b.milestones.toArray());if(!N||!j)return e.jsx("div",{className:"p-4 text-[var(--text-muted)]",children:"Loading..."});if(N.length===0)return e.jsx("div",{className:"space-y-5",children:e.jsxs("div",{className:"bg-[var(--bg-table-header)] border border-[var(--border-default)] rounded-lg p-8 text-center",children:[e.jsx("p",{className:"text-[var(--text-secondary)]",children:"No NPD projects found."}),e.jsx("p",{className:"text-[13px] text-[var(--text-muted)] mt-2",children:"Import timesheet data or add projects in the Projects tab."})]})});const n=new Map(j.map(c=>[c.project_id,c])),o=async(c,u,p)=>{const f=n.get(c),h={project_id:c,dr1:f?.dr1??null,dr2:f?.dr2??null,dr3:f?.dr3??null,launch:f?.launch??null,[u]:p||null};await b.milestones.put(h),g({[c+u]:!0}),setTimeout(()=>g({}),1e3)},r=c=>{const u=n.get(c);if(!u)return{phase:"—",color:"text-[var(--text-muted)] italic"};const p=new Date,f={dr1:u.dr1?new Date(u.dr1):null,dr2:u.dr2?new Date(u.dr2):null,dr3:u.dr3?new Date(u.dr3):null,launch:u.launch?new Date(u.launch):null};return!f.dr1&&!f.dr2&&!f.dr3&&!f.launch?{phase:"—",color:"text-[var(--text-muted)] italic"}:f.launch&&p>=f.launch?{phase:"Launched",color:"text-[var(--status-good)] font-medium"}:f.dr3&&p>=f.dr3?{phase:"DR3 → Launch",color:"text-[var(--accent)]"}:f.dr2&&p>=f.dr2?{phase:"DR2 → DR3",color:"text-[var(--accent)]"}:f.dr1&&p>=f.dr1?{phase:"DR1 → DR2",color:"text-[var(--text-secondary)]"}:{phase:"Pre-DR1",color:"text-[var(--text-muted)]"}},m=c=>{const u=n.get(c);if(!u)return null;const p={dr1:u.dr1?new Date(u.dr1):null,dr2:u.dr2?new Date(u.dr2):null,dr3:u.dr3?new Date(u.dr3):null,launch:u.launch?new Date(u.launch):null};return p.dr1&&p.dr2&&p.dr1>=p.dr2?`DR2 (${u.dr2}) should be after DR1 (${u.dr1})`:p.dr2&&p.dr3&&p.dr2>=p.dr3?`DR3 (${u.dr3}) should be after DR2 (${u.dr2})`:p.dr3&&p.launch&&p.dr3>=p.launch?`Launch (${u.launch}) should be after DR3 (${u.dr3})`:null};return e.jsxs("div",{className:"space-y-5",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-[var(--border-default)]",children:[e.jsx("thead",{className:"bg-[var(--bg-table-header)]",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-3 text-left text-[11px] font-medium text-[var(--text-muted)] uppercase tracking-[0.05em]",children:"Project ID"}),e.jsx("th",{className:"px-3 py-3 text-left text-[11px] font-medium text-[var(--text-muted)] uppercase tracking-[0.05em]",children:"Project Name"}),e.jsx("th",{className:"px-3 py-3 text-left text-[11px] font-medium text-[var(--text-muted)] uppercase tracking-[0.05em]",children:"DR1"}),e.jsx("th",{className:"px-3 py-3 text-left text-[11px] font-medium text-[var(--text-muted)] uppercase tracking-[0.05em]",children:"DR2"}),e.jsx("th",{className:"px-3 py-3 text-left text-[11px] font-medium text-[var(--text-muted)] uppercase tracking-[0.05em]",children:"DR3"}),e.jsx("th",{className:"px-3 py-3 text-left text-[11px] font-medium text-[var(--text-muted)] uppercase tracking-[0.05em]",children:"Launch"}),e.jsx("th",{className:"px-3 py-3 text-left text-[11px] font-medium text-[var(--text-muted)] uppercase tracking-[0.05em]",children:"Status"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-[var(--border-subtle)]",children:N.map(c=>{const u=n.get(c.project_id),{phase:p,color:f}=r(c.project_id),h=m(c.project_id);return e.jsxs("tr",{className:"hover:bg-[var(--bg-table-hover)]",children:[e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-[13px] font-medium text-[var(--text-primary)]",children:c.project_id}),e.jsx("td",{className:"px-3 py-2 text-[13px] text-[var(--text-secondary)]",children:c.project_name}),e.jsxs("td",{className:"px-3 py-2 whitespace-nowrap",children:[e.jsx("input",{type:"date",value:u?.dr1||"",onChange:y=>o(c.project_id,"dr1",y.target.value),className:"block w-full px-2 py-1 text-[13px] border border-[var(--border-input)] rounded-md bg-[var(--bg-input)] text-[var(--text-primary)] focus:ring-2 focus:ring-[var(--accent-focus-ring)] focus:border-[var(--border-focus)]"}),i[c.project_id+"dr1"]&&e.jsx("span",{className:"text-xs text-[var(--status-good)]",children:"✓"})]}),e.jsxs("td",{className:"px-3 py-2 whitespace-nowrap",children:[e.jsx("input",{type:"date",value:u?.dr2||"",onChange:y=>o(c.project_id,"dr2",y.target.value),className:"block w-full px-2 py-1 text-[13px] border border-[var(--border-input)] rounded-md bg-[var(--bg-input)] text-[var(--text-primary)] focus:ring-2 focus:ring-[var(--accent-focus-ring)] focus:border-[var(--border-focus)]"}),i[c.project_id+"dr2"]&&e.jsx("span",{className:"text-xs text-[var(--status-good)]",children:"✓"})]}),e.jsxs("td",{className:"px-3 py-2 whitespace-nowrap",children:[e.jsx("input",{type:"date",value:u?.dr3||"",onChange:y=>o(c.project_id,"dr3",y.target.value),className:"block w-full px-2 py-1 text-[13px] border border-[var(--border-input)] rounded-md bg-[var(--bg-input)] text-[var(--text-primary)] focus:ring-2 focus:ring-[var(--accent-focus-ring)] focus:border-[var(--border-focus)]"}),i[c.project_id+"dr3"]&&e.jsx("span",{className:"text-xs text-[var(--status-good)]",children:"✓"})]}),e.jsxs("td",{className:"px-3 py-2 whitespace-nowrap",children:[e.jsx("input",{type:"date",value:u?.launch||"",onChange:y=>o(c.project_id,"launch",y.target.value),className:"block w-full px-2 py-1 text-[13px] border border-[var(--border-input)] rounded-md bg-[var(--bg-input)] text-[var(--text-primary)] focus:ring-2 focus:ring-[var(--accent-focus-ring)] focus:border-[var(--border-focus)]"}),i[c.project_id+"launch"]&&e.jsx("span",{className:"text-xs text-[var(--status-good)]",children:"✓"})]}),e.jsxs("td",{className:"px-3 py-2 whitespace-nowrap",children:[e.jsx("div",{className:`text-[13px] ${f}`,children:p}),h&&e.jsx("div",{className:"text-xs text-[var(--status-danger)] mt-1",children:h})]})]},c.project_id)})})]})}),e.jsx("div",{className:"text-[13px] text-[var(--text-muted)]",children:e.jsxs("p",{children:["Showing ",N.length," NPD projects"]})})]})}function pe(){const[i,g]=k.useState(""),[N,j]=k.useState(!1),[n,o]=k.useState({month:"",project_id:"",total_planned_hours:0}),r=S(()=>b.timesheets.toArray()),m=S(()=>b.plannedProjectMonths.toArray()),c=S(()=>b.projects.toArray());if(!r||!m||!c)return e.jsx("div",{className:"p-4 text-[var(--text-muted)]",children:"Loading..."});const u=new Set(r.map(d=>U(d.month))),p=Array.from(u).sort().reverse();!i&&p.length>0&&g(p[0]);const f=i?m.filter(d=>d.month===i):m,h=new Map(c.map(d=>[d.project_id,d])),y=async()=>{if(!n.project_id||!n.month){alert("Please select both month and project");return}if(m.some(w=>w.month===n.month&&w.project_id===n.project_id)){alert(`${n.project_id} already has planned hours for ${n.month}`);return}await b.plannedProjectMonths.add(n),o({month:i,project_id:"",total_planned_hours:0}),j(!1)},v=async(d,w,A)=>{await b.plannedProjectMonths.where({month:d,project_id:w}).modify({total_planned_hours:A})},a=async(d,w)=>{confirm(`Delete planned hours for ${w} in ${d}?`)&&await b.plannedProjectMonths.where({month:d,project_id:w}).delete()},t=async()=>{if(!i){alert("Select a month first");return}const[d,w]=i.split("-").map(Number),A=new Date(d,w-2,1),D=`${A.getFullYear()}-${String(A.getMonth()+1).padStart(2,"0")}`,F=m.filter(s=>s.month===D);if(F.length===0){alert(`No data found for ${D}`);return}let $=0;for(const s of F)m.some(_=>_.month===i&&_.project_id===s.project_id)||(await b.plannedProjectMonths.add({month:i,project_id:s.project_id,total_planned_hours:s.total_planned_hours}),$++);alert(`Copied ${$} entries from ${D} to ${i}`)},l=f.reduce((d,w)=>d+w.total_planned_hours,0);return e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"flex items-center justify-end gap-3",children:[e.jsx("button",{onClick:t,disabled:!i,className:"text-[13px] font-medium px-4 py-2 rounded-md border border-[var(--border-input)] text-[var(--text-secondary)] bg-white hover:bg-[var(--bg-table-header)] disabled:opacity-50 disabled:cursor-not-allowed",children:"Copy from Previous Month"}),e.jsx("button",{onClick:()=>{o({month:i,project_id:"",total_planned_hours:0}),j(!0)},className:"text-[13px] font-medium px-4 py-2 rounded-md text-white bg-[var(--accent)] hover:bg-[var(--accent-hover)]",children:"+ Add Entry"})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("label",{className:"text-[13px] font-medium text-[var(--text-secondary)]",children:"Filter by month:"}),e.jsxs("select",{value:i,onChange:d=>g(d.target.value),className:"text-[13px] px-3 py-2 border border-[var(--border-input)] rounded-md bg-[var(--bg-input)] text-[var(--text-primary)] focus:ring-2 focus:ring-[var(--accent-focus-ring)]",children:[e.jsx("option",{value:"",children:"All months"}),p.map(d=>e.jsx("option",{value:d,children:d},d))]}),i&&e.jsxs("span",{className:"text-[13px] text-[var(--text-secondary)]",children:[f.length," entries • Total: ",l.toFixed(1)," hours"]})]}),f.length===0&&!N?e.jsxs("div",{className:"bg-[var(--bg-table-header)] border border-[var(--border-default)] rounded-lg p-8 text-center",children:[e.jsx("p",{className:"text-[var(--text-secondary)]",children:"No planned hours entries."}),e.jsx("p",{className:"text-[13px] text-[var(--text-muted)] mt-2",children:'Click "Add Entry" to start planning.'})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-[var(--border-default)]",children:[e.jsx("thead",{className:"bg-[var(--bg-table-header)]",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-3 text-left text-[11px] font-medium text-[var(--text-muted)] uppercase tracking-[0.05em]",children:"Month"}),e.jsx("th",{className:"px-3 py-3 text-left text-[11px] font-medium text-[var(--text-muted)] uppercase tracking-[0.05em]",children:"Project ID"}),e.jsx("th",{className:"px-3 py-3 text-left text-[11px] font-medium text-[var(--text-muted)] uppercase tracking-[0.05em]",children:"Project Name"}),e.jsx("th",{className:"px-3 py-3 text-left text-[11px] font-medium text-[var(--text-muted)] uppercase tracking-[0.05em]",children:"Planned Hours"}),e.jsx("th",{className:"px-3 py-3 text-left text-[11px] font-medium text-[var(--text-muted)] uppercase tracking-[0.05em]",children:"Actions"})]})}),e.jsxs("tbody",{className:"bg-white divide-y divide-[var(--border-subtle)]",children:[N&&e.jsxs("tr",{className:"bg-[var(--accent-light)]",children:[e.jsx("td",{className:"px-3 py-2",children:e.jsx("input",{type:"month",value:n.month,onChange:d=>o({...n,month:d.target.value}),className:"block w-full px-2 py-1 text-[13px] border border-[var(--border-input)] rounded-md bg-[var(--bg-input)] text-[var(--text-primary)]"})}),e.jsx("td",{className:"px-3 py-2",colSpan:2,children:e.jsxs("select",{value:n.project_id,onChange:d=>o({...n,project_id:d.target.value}),className:"block w-full px-2 py-1 text-[13px] border border-[var(--border-input)] rounded-md bg-[var(--bg-input)] text-[var(--text-primary)]",children:[e.jsx("option",{value:"",children:"Select project..."}),c.map(d=>e.jsxs("option",{value:d.project_id,children:[d.project_id," — ",d.project_name]},d.project_id))]})}),e.jsx("td",{className:"px-3 py-2",children:e.jsx("input",{type:"number",value:n.total_planned_hours,onChange:d=>o({...n,total_planned_hours:Number(d.target.value)}),className:"block w-full px-2 py-1 text-[13px] border border-[var(--border-input)] rounded-md bg-[var(--bg-input)] text-[var(--text-primary)]",min:"0",step:"0.1"})}),e.jsx("td",{className:"px-3 py-2",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:y,className:"text-[12px] font-medium px-2.5 py-1 rounded text-[var(--status-good)] hover:bg-[var(--status-good-bg)]",children:"Save"}),e.jsx("button",{onClick:()=>j(!1),className:"text-[12px] font-medium px-2.5 py-1 rounded text-[var(--text-muted)] hover:text-[var(--text-secondary)] hover:bg-[var(--bg-table-hover)]",children:"Cancel"})]})})]}),f.sort((d,w)=>d.month!==w.month?w.month.localeCompare(d.month):d.project_id.localeCompare(w.project_id)).map(d=>{const w=h.get(d.project_id),A=d.total_planned_hours>200;return e.jsxs("tr",{className:"hover:bg-[var(--bg-table-hover)]",children:[e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-[13px] text-[var(--text-secondary)]",children:d.month}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-[13px] font-medium text-[var(--text-primary)]",children:d.project_id}),e.jsx("td",{className:"px-3 py-2 text-[13px] text-[var(--text-secondary)]",children:w?.project_name||"—"}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"number",value:d.total_planned_hours,onChange:D=>v(d.month,d.project_id,Number(D.target.value)),className:"block w-24 px-2 py-1 text-[13px] border border-[var(--border-input)] rounded-md bg-[var(--bg-input)] text-[var(--text-primary)] focus:ring-2 focus:ring-[var(--accent-focus-ring)]",min:"0",step:"0.1"}),A&&e.jsx("span",{className:"text-xs text-[var(--status-warn)]",title:"Unusually high hours",children:"⚠️"})]})}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:e.jsx("button",{onClick:()=>a(d.month,d.project_id),className:"text-[12px] font-medium px-2.5 py-1 rounded text-[var(--status-danger)] hover:bg-[var(--status-danger-bg)]",children:"Delete"})})]},`${d.month}-${d.project_id}`)})]})]})})]})}function ue(){const[i,g]=k.useState(""),[N,j]=k.useState(!1),[n,o]=k.useState({month:"",project_id:"",engineer:"",allocation_pct:0,planned_hours:0,autoCalculated:!0}),r=S(()=>b.timesheets.toArray()),m=S(()=>b.plannedAllocations.toArray()),c=S(()=>b.projects.toArray()),u=S(()=>b.teamMembers.toArray()),p=S(()=>b.config.get(1));if(!r||!m||!c||!u||!p)return e.jsx("div",{className:"p-4 text-[var(--text-muted)]",children:"Loading..."});const f=u.filter(s=>s.role===E.Engineer).sort((s,x)=>s.full_name.localeCompare(x.full_name)),h=new Set(r.map(s=>U(s.month))),y=Array.from(h).sort().reverse();!i&&y.length>0&&g(y[0]);const v=i?m.filter(s=>s.month===i):m,a=new Map(c.map(s=>[s.project_id,s])),t=s=>{const x=u.find(_=>_.full_name===s);return x?.capacity_override_hours&&x.capacity_override_hours>0?x.capacity_override_hours:p.std_monthly_capacity_hours},l=(s,x)=>{const _=t(s);return x/100*_},d=(s,x,_,C)=>{const M=t(_),T=C/100*M;b.plannedAllocations.where({month:s,project_id:x,engineer:_}).modify({allocation_pct:C,planned_hours:T})},w=(s,x,_,C)=>{b.plannedAllocations.where({month:s,project_id:x,engineer:_}).modify({planned_hours:C})},A=async()=>{if(!n.month||!n.project_id||!n.engineer){alert("Please fill in month, project, and engineer");return}if(m.some(x=>x.month===n.month&&x.project_id===n.project_id&&x.engineer===n.engineer)){alert(`${n.engineer} already has an allocation for ${n.project_id} in ${n.month}`);return}await b.plannedAllocations.add({month:n.month,project_id:n.project_id,engineer:n.engineer,allocation_pct:n.allocation_pct,planned_hours:n.planned_hours}),o({month:i,project_id:"",engineer:"",allocation_pct:0,planned_hours:0,autoCalculated:!0}),j(!1)},D=async(s,x,_)=>{confirm(`Delete allocation for ${_} on ${x} in ${s}?`)&&await b.plannedAllocations.where({month:s,project_id:x,engineer:_}).delete()},F=async()=>{if(!i){alert("Select a month first");return}const[s,x]=i.split("-").map(Number),_=new Date(s,x-2,1),C=`${_.getFullYear()}-${String(_.getMonth()+1).padStart(2,"0")}`,M=m.filter(P=>P.month===C);if(M.length===0){alert(`No data found for ${C}`);return}let T=0;for(const P of M)m.some(z=>z.month===i&&z.project_id===P.project_id&&z.engineer===P.engineer)||(await b.plannedAllocations.add({month:i,project_id:P.project_id,engineer:P.engineer,allocation_pct:P.allocation_pct,planned_hours:P.planned_hours}),T++);alert(`Copied ${T} entries from ${C} to ${i}`)},$=f.map(s=>{const x=v.filter(T=>T.engineer===s.full_name).reduce((T,P)=>T+P.planned_hours,0),_=t(s.full_name),C=_>0?x/_*100:0;let M;return C<80?M="under":C<=100?M="healthy":C<=120?M="over":M="critical",{engineer:s.full_name,totalHours:x,capacity:_,utilizationPct:C,status:M}});return e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"flex items-center justify-end gap-3",children:[e.jsx("button",{onClick:F,disabled:!i,className:"text-[13px] font-medium px-4 py-2 rounded-md border border-[var(--border-input)] text-[var(--text-secondary)] bg-white hover:bg-[var(--bg-table-header)] disabled:opacity-50",children:"Copy from Previous Month"}),e.jsx("button",{onClick:()=>{o({month:i,project_id:"",engineer:"",allocation_pct:100,planned_hours:0,autoCalculated:!0}),j(!0)},className:"text-[13px] font-medium px-4 py-2 rounded-md text-white bg-[var(--accent)] hover:bg-[var(--accent-hover)]",children:"+ Add Allocation"})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("label",{className:"text-[13px] font-medium text-[var(--text-secondary)]",children:"Filter by month:"}),e.jsxs("select",{value:i,onChange:s=>g(s.target.value),className:"text-[13px] px-3 py-2 border border-[var(--border-input)] rounded-md bg-[var(--bg-input)] text-[var(--text-primary)] focus:ring-2 focus:ring-[var(--accent-focus-ring)]",children:[e.jsx("option",{value:"",children:"All months"}),y.map(s=>e.jsx("option",{value:s,children:s},s))]}),i&&e.jsxs("span",{className:"text-[13px] text-[var(--text-secondary)]",children:[v.length," allocations"]})]}),i&&$.length>0&&e.jsxs("div",{className:"bg-[var(--bg-panel)] border border-[var(--border-default)] rounded-lg p-4",children:[e.jsxs("h3",{className:"text-[13px] font-semibold text-[var(--text-primary)] mb-3",children:["Engineer Utilization Summary (",i,")"]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 text-[13px]",children:$.map(s=>e.jsxs("div",{className:`flex items-center justify-between px-3 py-2 rounded ${s.status==="under"?"bg-[var(--bg-table-header)] text-[var(--text-secondary)]":s.status==="healthy"?"bg-[var(--status-good-bg)] text-[var(--status-good)]":s.status==="over"?"bg-[var(--status-warn-bg)] text-[var(--status-warn)]":"bg-[var(--status-danger-bg)] text-[var(--status-danger)]"}`,children:[e.jsx("span",{className:"font-medium",children:s.engineer}),e.jsxs("span",{children:[s.totalHours.toFixed(0)," / ",s.capacity," = ",s.utilizationPct.toFixed(0),"%",s.status==="over"&&" ⚠️",s.status==="critical"&&" ⚠️⚠️",s.status==="healthy"&&" ✓"]})]},s.engineer))})]}),v.length===0&&!N?e.jsxs("div",{className:"bg-[var(--bg-table-header)] border border-[var(--border-default)] rounded-lg p-8 text-center",children:[e.jsx("p",{className:"text-[var(--text-secondary)]",children:"No allocations."}),e.jsx("p",{className:"text-[13px] text-[var(--text-muted)] mt-2",children:'Click "Add Allocation" to assign engineers to projects.'})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-[var(--border-default)]",children:[e.jsx("thead",{className:"bg-[var(--bg-table-header)]",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-3 text-left text-[11px] font-medium text-[var(--text-muted)] uppercase tracking-[0.05em]",children:"Month"}),e.jsx("th",{className:"px-3 py-3 text-left text-[11px] font-medium text-[var(--text-muted)] uppercase tracking-[0.05em]",children:"Project"}),e.jsx("th",{className:"px-3 py-3 text-left text-[11px] font-medium text-[var(--text-muted)] uppercase tracking-[0.05em]",children:"Engineer"}),e.jsx("th",{className:"px-3 py-3 text-left text-[11px] font-medium text-[var(--text-muted)] uppercase tracking-[0.05em]",children:"Alloc %"}),e.jsx("th",{className:"px-3 py-3 text-left text-[11px] font-medium text-[var(--text-muted)] uppercase tracking-[0.05em]",children:"Planned Hours"}),e.jsx("th",{className:"px-3 py-3 text-left text-[11px] font-medium text-[var(--text-muted)] uppercase tracking-[0.05em]",children:"Actions"})]})}),e.jsxs("tbody",{className:"bg-white divide-y divide-[var(--border-subtle)]",children:[N&&e.jsxs("tr",{className:"bg-[var(--accent-light)]",children:[e.jsx("td",{className:"px-3 py-2",children:e.jsx("input",{type:"month",value:n.month,onChange:s=>o({...n,month:s.target.value}),className:"block w-full px-2 py-1 text-[13px] border border-[var(--border-input)] rounded-md bg-[var(--bg-input)] text-[var(--text-primary)]"})}),e.jsx("td",{className:"px-3 py-2",children:e.jsxs("select",{value:n.project_id,onChange:s=>o({...n,project_id:s.target.value}),className:"block w-full px-2 py-1 text-[13px] border border-[var(--border-input)] rounded-md bg-[var(--bg-input)] text-[var(--text-primary)]",children:[e.jsx("option",{value:"",children:"Select..."}),c.map(s=>e.jsxs("option",{value:s.project_id,children:[s.project_id," — ",s.project_name.substring(0,30)]},s.project_id))]})}),e.jsx("td",{className:"px-3 py-2",children:e.jsxs("select",{value:n.engineer,onChange:s=>{const x=s.target.value,_=n.autoCalculated?l(x,n.allocation_pct):n.planned_hours;o({...n,engineer:x,planned_hours:_})},className:"block w-full px-2 py-1 text-[13px] border border-[var(--border-input)] rounded-md bg-[var(--bg-input)] text-[var(--text-primary)]",children:[e.jsx("option",{value:"",children:"Select..."}),f.map(s=>e.jsx("option",{value:s.full_name,children:s.full_name},s.person_id))]})}),e.jsx("td",{className:"px-3 py-2",children:e.jsx("input",{type:"number",value:n.allocation_pct,onChange:s=>{const x=Number(s.target.value),_=n.engineer&&n.autoCalculated?l(n.engineer,x):n.planned_hours;o({...n,allocation_pct:x,planned_hours:_})},className:"block w-20 px-2 py-1 text-[13px] border border-[var(--border-input)] rounded-md bg-[var(--bg-input)] text-[var(--text-primary)]",min:"0",max:"200"})}),e.jsx("td",{className:"px-3 py-2",children:e.jsx("input",{type:"number",value:n.planned_hours,onChange:s=>o({...n,planned_hours:Number(s.target.value),autoCalculated:!1}),className:"block w-24 px-2 py-1 text-[13px] border border-[var(--border-input)] rounded-md bg-[var(--bg-input)] text-[var(--text-primary)]",min:"0",step:"0.1"})}),e.jsx("td",{className:"px-3 py-2",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:A,className:"text-[12px] font-medium px-2.5 py-1 rounded text-[var(--status-good)] hover:bg-[var(--status-good-bg)]",children:"Save"}),e.jsx("button",{onClick:()=>j(!1),className:"text-[12px] font-medium px-2.5 py-1 rounded text-[var(--text-muted)] hover:text-[var(--text-secondary)] hover:bg-[var(--bg-table-hover)]",children:"Cancel"})]})})]}),v.sort((s,x)=>s.month!==x.month?x.month.localeCompare(s.month):s.project_id!==x.project_id?s.project_id.localeCompare(x.project_id):s.engineer.localeCompare(x.engineer)).map(s=>{const x=a.get(s.project_id),_=s.allocation_pct>100;return e.jsxs("tr",{className:"hover:bg-[var(--bg-table-hover)]",children:[e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-[13px] text-[var(--text-secondary)]",children:s.month}),e.jsxs("td",{className:"px-3 py-2 text-[13px] font-medium text-[var(--text-primary)]",children:[s.project_id,e.jsx("div",{className:"text-[11px] text-[var(--text-muted)]",children:x?.project_name?.substring(0,40)})]}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-[13px] text-[var(--text-secondary)]",children:s.engineer}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("input",{type:"number",value:s.allocation_pct,onChange:C=>d(s.month,s.project_id,s.engineer,Number(C.target.value)),className:"block w-16 px-2 py-1 text-[13px] border border-[var(--border-input)] rounded-md bg-[var(--bg-input)] text-[var(--text-primary)] focus:ring-2 focus:ring-[var(--accent-focus-ring)]",min:"0",max:"200"}),e.jsx("span",{className:"text-[11px] text-[var(--text-muted)]",children:"%"}),_&&e.jsx("span",{className:"text-xs text-[var(--status-warn)]",title:"Allocation >100%",children:"⚠️"})]})}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:e.jsx("input",{type:"number",value:s.planned_hours,onChange:C=>w(s.month,s.project_id,s.engineer,Number(C.target.value)),className:"block w-20 px-2 py-1 text-[13px] border border-[var(--border-input)] rounded-md bg-[var(--bg-input)] text-[var(--text-primary)] focus:ring-2 focus:ring-[var(--accent-focus-ring)]",min:"0",step:"0.1"})}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:e.jsx("button",{onClick:()=>D(s.month,s.project_id,s.engineer),className:"text-[12px] font-medium px-2.5 py-1 rounded text-[var(--status-danger)] hover:bg-[var(--status-danger-bg)]",children:"Delete"})})]},`${s.month}-${s.project_id}-${s.engineer}`)})]})]})})]})}const me={alert:{bg:"#fef2f2",text:"#dc2626"},warning:{bg:"#fffbeb",text:"#d97706"},info:{bg:"#eff6ff",text:"#2563eb"}};function he(){const i=S(()=>b.anomalyThresholds.toArray());if(!i)return e.jsx("div",{className:"animate-pulse space-y-4",children:[...Array(4)].map((r,m)=>e.jsx("div",{className:"h-32 bg-[var(--border-subtle)] rounded-lg"},m))});const g=new Map(i.map(r=>[r.ruleId,r])),N=async r=>{const m=g.get(r),c=I.find(u=>u.ruleId===r);await b.anomalyThresholds.put({ruleId:r,enabled:m?!m.enabled:!c.defaultEnabled,severity:m?.severity??c.defaultSeverity,thresholds:m?.thresholds??L(r)})},j=async(r,m)=>{const c=g.get(r),u=I.find(p=>p.ruleId===r);await b.anomalyThresholds.put({ruleId:r,enabled:c?.enabled??u.defaultEnabled,severity:m,thresholds:c?.thresholds??L(r)})},n=async(r,m,c)=>{const u=g.get(r),p=I.find(h=>h.ruleId===r),f=u?.thresholds??L(r);await b.anomalyThresholds.put({ruleId:r,enabled:u?.enabled??p.defaultEnabled,severity:u?.severity??p.defaultSeverity,thresholds:{...f,[m]:c}})},o=async r=>{const m=I.find(c=>c.ruleId===r);await b.anomalyThresholds.put({ruleId:r,enabled:m.defaultEnabled,severity:m.defaultSeverity,thresholds:L(r)})};return e.jsx("div",{className:"space-y-4",children:I.map(r=>{const m=g.get(r.ruleId),c=m?.enabled??r.defaultEnabled,u=m?.severity??r.defaultSeverity,p=m?.thresholds??L(r.ruleId),f=me[u];return e.jsxs("div",{className:`border rounded-lg overflow-hidden transition-opacity ${c?"border-[var(--border-default)]":"border-[var(--border-subtle)] opacity-60"}`,children:[e.jsxs("div",{className:"flex items-center gap-3 px-4 py-3 bg-[var(--bg-table-header)]",children:[e.jsxs("label",{className:"flex items-center gap-2 flex-1 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:c,onChange:()=>N(r.ruleId),className:"w-4 h-4 rounded border-[var(--border-input)] text-[var(--accent)] focus:ring-[var(--accent-focus-ring)]"}),e.jsx("span",{className:"text-[13px] font-semibold text-[var(--text-primary)]",children:r.name}),e.jsxs("span",{className:"text-[11px] text-[var(--text-muted)] font-normal",children:["(",r.category,")"]})]}),e.jsxs("select",{value:u,onChange:h=>j(r.ruleId,h.target.value),disabled:!c,className:"text-[11px] font-semibold px-2 py-1 rounded-full border-0 cursor-pointer",style:{backgroundColor:c?f.bg:"var(--border-subtle)",color:c?f.text:"var(--text-muted)"},children:[e.jsx("option",{value:"info",children:"info"}),e.jsx("option",{value:"warning",children:"warning"}),e.jsx("option",{value:"alert",children:"alert"})]})]}),c&&e.jsxs("div",{className:"px-4 py-3 space-y-3",children:[e.jsx("p",{className:"text-[13px] text-[var(--text-secondary)]",children:r.description}),e.jsxs("div",{className:"border-l-2 border-[var(--accent)] pl-3 py-1",children:[e.jsx("p",{className:"text-[11px] font-semibold uppercase tracking-wider text-[var(--text-muted)] mb-1",children:"Why this matters"}),e.jsx("p",{className:"text-[12px] text-[var(--text-secondary)] italic",children:r.rationale})]}),r.parameters.length>0&&e.jsx("div",{className:"space-y-3 pt-1",children:r.parameters.map(h=>{const y=p[h.key]??h.defaultValue,v=y!==h.defaultValue;return e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("label",{className:"text-[13px] font-medium text-[var(--text-primary)]",children:[h.label,v&&e.jsx("span",{className:"ml-1.5 text-[10px] text-[var(--accent)] font-normal",children:"(modified)"})]}),e.jsx("p",{className:"text-[11px] text-[var(--text-muted)] mt-0.5",children:h.description})]}),e.jsxs("div",{className:"flex items-center gap-1.5 flex-shrink-0",children:[e.jsx("input",{type:"number",value:y,min:h.min,max:h.max,step:h.step,onChange:a=>{const t=parseFloat(a.target.value);!isNaN(t)&&t>=h.min&&t<=h.max&&n(r.ruleId,h.key,t)},className:"w-20 px-2 py-1.5 text-[13px] border border-[var(--border-input)] rounded-md bg-[var(--bg-input)] text-[var(--text-primary)] focus:ring-2 focus:ring-[var(--accent-focus-ring)] focus:outline-none tabular-nums text-right"}),h.unit&&e.jsx("span",{className:"text-[11px] text-[var(--text-muted)] w-12",children:h.unit})]})]},h.key)})}),e.jsx("div",{className:"pt-1",children:e.jsx("button",{onClick:()=>o(r.ruleId),className:"text-[11px] text-[var(--accent)] hover:underline",children:"Reset to defaults"})})]})]},r.ruleId)})})}function ve(){const i=S(()=>b.narrativeConfig.get(1)),g=S(()=>b.config.get(1)),N=g?.selected_month,j=g?.selected_project||void 0,n=S(async()=>N?await ee(N,j):null,[N,j,i]),o=i??te,[r,m]=k.useState(null),[c,u]=k.useState(null),[p,f]=k.useState(null),[h,y]=k.useState(null),v=async x=>{await b.narrativeConfig.put({...o,...x})},a=x=>{v({observations:{...o.observations,[x]:!o.observations[x]}})},t=x=>{f(x)},l=(x,_)=>{x.preventDefault(),y(_)},d=x=>{if(p===null)return;const _=[...o.observationPriority],C=_.indexOf(p);if(C===-1||C===x){f(null),y(null);return}_.splice(C,1),_.splice(x,0,p),v({observationPriority:_}),f(null),y(null)},w=()=>{f(null),y(null)},A=x=>{v({[x]:!o[x]})},D=x=>{v({maxObservations:x})},F=()=>{r!==null&&(v({customOpening:r}),m(null))},$=()=>{c!==null&&(v({customClosing:c}),u(null))},s=o.observationPriority.map(x=>({...re.find(C=>C.key===x),enabled:o.observations[x]}));return e.jsxs("div",{className:"space-y-8",children:[e.jsxs("section",{children:[e.jsx("h3",{className:"text-[11px] font-semibold uppercase tracking-wider text-[var(--text-muted)] mb-1",children:"Observations to Include"}),e.jsx("p",{className:"text-[12px] text-[var(--text-secondary)] mb-3",children:"The summary highlights the top observations from the month. Enable the ones you want eligible and drag to set priority. Higher items are selected first when multiple trigger."}),e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx("label",{className:"text-[13px] font-medium text-[var(--text-secondary)]",children:"Max observations in summary:"}),e.jsxs("select",{value:o.maxObservations,onChange:x=>D(parseInt(x.target.value)),className:"text-[13px] px-2 py-1.5 border border-[var(--border-input)] rounded-md bg-[var(--bg-input)] text-[var(--text-primary)] focus:ring-2 focus:ring-[var(--accent-focus-ring)] focus:outline-none",children:[e.jsx("option",{value:1,children:"1"}),e.jsx("option",{value:2,children:"2"}),e.jsx("option",{value:3,children:"3"})]})]}),e.jsx("div",{className:"space-y-1.5",children:s.map((x,_)=>e.jsxs("div",{draggable:!0,onDragStart:()=>t(x.key),onDragOver:C=>l(C,_),onDrop:()=>d(_),onDragEnd:w,className:`flex items-center gap-3 px-3 py-2.5 border rounded-lg transition-colors ${h===_?"border-[var(--accent)] bg-blue-50":x.enabled?"border-[var(--border-default)] bg-white":"border-[var(--border-subtle)] opacity-50"} ${p===x.key?"opacity-40":""}`,children:[e.jsx("span",{className:"cursor-grab text-[var(--text-muted)] select-none flex-shrink-0",style:{fontSize:"16px"},children:"⠿"}),e.jsx("span",{className:"w-6 h-6 flex items-center justify-center rounded-full bg-[var(--bg-table-header)] text-[11px] font-bold text-[var(--text-muted)] flex-shrink-0",children:_+1}),e.jsx("input",{type:"checkbox",checked:x.enabled,onChange:()=>a(x.key),className:"w-4 h-4 rounded border-[var(--border-input)] text-[var(--accent)] focus:ring-[var(--accent-focus-ring)] flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("span",{className:"text-[13px] font-semibold text-[var(--text-primary)]",children:x.label}),e.jsxs("p",{className:"text-[11px] italic text-[var(--text-muted)] mt-0.5",children:["“",x.teamTemplate,"”"]})]})]},x.key))})]}),e.jsxs("section",{children:[e.jsx("h3",{className:"text-[11px] font-semibold uppercase tracking-wider text-[var(--text-muted)] mb-1",children:"Tone & Language"}),e.jsx("p",{className:"text-[12px] text-[var(--text-secondary)] mb-3",children:"Control the level of detail and specificity in the narrative."}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:"flex items-start gap-2.5 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:o.nameIndividuals,onChange:()=>A("nameIndividuals"),className:"w-4 h-4 mt-0.5 rounded border-[var(--border-input)] text-[var(--accent)] focus:ring-[var(--accent-focus-ring)]"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-[13px] font-medium text-[var(--text-primary)]",children:"Name individuals in summary"}),e.jsx("p",{className:"text-[12px] text-[var(--text-muted)] mt-0.5",children:"When off, names are replaced with “one engineer” or “a team member.”"})]})]}),e.jsxs("label",{className:"flex items-start gap-2.5 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:o.includeSpecificNumbers,onChange:()=>A("includeSpecificNumbers"),className:"w-4 h-4 mt-0.5 rounded border-[var(--border-input)] text-[var(--accent)] focus:ring-[var(--accent-focus-ring)]"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-[13px] font-medium text-[var(--text-primary)]",children:"Include specific numbers"}),e.jsx("p",{className:"text-[12px] text-[var(--text-muted)] mt-0.5",children:"When off, percentages and hours are replaced with relative language (“above target”, “significantly”)."})]})]}),e.jsxs("label",{className:"flex items-start gap-2.5 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:o.includeTrendComparisons,onChange:()=>A("includeTrendComparisons"),className:"w-4 h-4 mt-0.5 rounded border-[var(--border-input)] text-[var(--accent)] focus:ring-[var(--accent-focus-ring)]"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-[13px] font-medium text-[var(--text-primary)]",children:"Include trend comparisons (when multi-month data exists)"}),e.jsx("p",{className:"text-[12px] text-[var(--text-muted)] mt-0.5",children:"Adds phrases like “up from 8% last month” or “continuing a 3-month trend.”"})]})]})]})]}),e.jsxs("section",{children:[e.jsx("h3",{className:"text-[11px] font-semibold uppercase tracking-wider text-[var(--text-muted)] mb-1",children:"Custom Framing (optional)"}),e.jsx("p",{className:"text-[12px] text-[var(--text-secondary)] mb-3",children:"Add optional opening or closing sentences to the narrative."}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-[13px] font-medium text-[var(--text-secondary)] mb-1.5",children:"Opening sentence"}),e.jsx("textarea",{value:r??o.customOpening,onChange:x=>m(x.target.value),onBlur:F,placeholder:'e.g., "The team had a strong month with solid NPD progress across key programs."',rows:2,className:"w-full text-[13px] px-3 py-2 border border-[var(--border-input)] rounded-md bg-[var(--bg-input)] text-[var(--text-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-focus-ring)] resize-none"}),e.jsx("p",{className:"text-[11px] text-[var(--text-muted)] mt-1",children:"Added before the auto-generated summary. Leave blank to use only auto-generated text."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-[13px] font-medium text-[var(--text-secondary)] mb-1.5",children:"Closing sentence"}),e.jsx("textarea",{value:c??o.customClosing,onChange:x=>u(x.target.value),onBlur:$,placeholder:'e.g., "We expect February to normalize as holiday carry-over clears."',rows:2,className:"w-full text-[13px] px-3 py-2 border border-[var(--border-input)] rounded-md bg-[var(--bg-input)] text-[var(--text-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-focus-ring)] resize-none"}),e.jsx("p",{className:"text-[11px] text-[var(--text-muted)] mt-1",children:"Added after the auto-generated summary."})]})]})]}),e.jsxs("section",{children:[e.jsx("h3",{className:"text-[11px] font-semibold uppercase tracking-wider text-[var(--text-muted)] mb-1",children:"Preview"}),e.jsx("div",{className:"border border-[var(--border-default)] rounded-lg p-4 bg-[var(--bg-table-header)]",children:N?n?e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-[14px] leading-relaxed text-[var(--text-primary)]",children:n.paragraph}),n.highlights.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 pt-1",children:n.highlights.map((x,_)=>e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-[11px] font-medium bg-[var(--accent-light)] text-[var(--accent)]",children:x},_))})]}):e.jsx("div",{className:"animate-pulse h-16 bg-[var(--border-subtle)] rounded"}):e.jsx("p",{className:"text-[13px] text-[var(--text-muted)] italic",children:"Select a month on the dashboard to see a preview."})}),N&&e.jsxs("p",{className:"text-[11px] text-[var(--text-muted)] mt-2",children:["Uses data from ",N,". Changes apply immediately to the dashboard."]})]})]})}function be(){const i=S(()=>b.config.get(1)),[g,N]=k.useState(null),[j,n]=k.useState(null);if(!i)return e.jsx("div",{className:"animate-pulse space-y-4",children:[...Array(4)].map((v,a)=>e.jsx("div",{className:"h-24 bg-[var(--border-subtle)] rounded-lg"},a))});const o=i.kpi_cards??q,r=async v=>{await b.config.update(1,{kpi_cards:v})},m=v=>{o.includes(v)?r(o.filter(a=>a!==v)):r([...o,v])},c=v=>{const a=K[v];a&&r([...a.cards])},u=v=>{N(v)},p=(v,a)=>{v.preventDefault(),n(a)},f=v=>{if(g===null)return;const a=o.indexOf(g);if(a===-1||a===v){N(null),n(null);return}const t=[...o];t.splice(a,1),t.splice(v,0,g),r(t),N(null),n(null)},h=()=>{N(null),n(null)},y=Object.keys(O);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-[13px] font-semibold text-[var(--text-primary)] mb-2",children:"Quick Presets"}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[Object.entries(K).map(([v,a])=>{const t=a.cards.length===o.length&&a.cards.every((l,d)=>o[d]===l);return e.jsx("button",{onClick:()=>c(v),className:`text-[12px] font-medium px-3 py-1.5 rounded-md border transition-colors ${t?"border-[var(--accent)] bg-[var(--accent)] text-white":"border-[var(--border-input)] text-[var(--text-secondary)] bg-white hover:bg-[var(--bg-table-header)]"}`,children:a.label},v)}),e.jsx("button",{onClick:()=>r([...q]),className:"text-[12px] font-medium px-3 py-1.5 rounded-md border border-[var(--border-input)] text-[var(--text-muted)] bg-white hover:bg-[var(--bg-table-header)] transition-colors",children:"Reset to Default"})]})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-[13px] font-semibold text-[var(--text-primary)] mb-1",children:["Active Cards (",o.length,")"]}),e.jsx("p",{className:"text-[12px] text-[var(--text-muted)] mb-2",children:"Drag to reorder. These cards appear on the dashboard KPI summary panel."}),e.jsxs("div",{className:"space-y-1",children:[o.map((v,a)=>{const t=O[v];return t?e.jsxs("div",{draggable:!0,onDragStart:()=>u(v),onDragOver:l=>p(l,a),onDrop:()=>f(a),onDragEnd:h,className:`flex items-center gap-3 px-3 py-2 rounded-md border transition-colors ${j===a?"border-[var(--accent)] bg-blue-50":"border-[var(--border-default)] bg-white"} ${g===v?"opacity-40":""}`,children:[e.jsx("span",{className:"cursor-grab text-[var(--text-muted)] select-none",style:{fontSize:"16px"},children:"⠿"}),e.jsx("span",{className:"text-[12px] font-medium text-[var(--text-muted)] w-5 text-right tabular-nums",children:a+1}),e.jsx("span",{className:"text-[13px] font-medium text-[var(--text-primary)] flex-1",children:t.label}),e.jsx("span",{className:"text-[11px] text-[var(--text-muted)] px-1.5 py-0.5 bg-[var(--bg-table-header)] rounded",children:t.category}),e.jsx("button",{onClick:()=>m(v),className:"text-[11px] text-red-500 hover:text-red-700 font-medium",children:"Remove"})]},v):null}),o.length===0&&e.jsx("p",{className:"text-[12px] text-[var(--text-muted)] italic py-4 text-center",children:"No cards selected. Choose from the categories below or apply a preset."})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-[13px] font-semibold text-[var(--text-primary)] mb-2",children:"Available KPIs"}),Q.map(v=>{const a=y.filter(t=>O[t].category===v.id);return e.jsxs("div",{className:"mb-4",children:[e.jsx("h4",{className:"text-[12px] font-semibold text-[var(--text-secondary)] uppercase tracking-wider mb-1.5",children:v.label}),e.jsx("div",{className:"space-y-1",children:a.map(t=>{const l=O[t],d=o.includes(t);return e.jsxs("label",{className:`flex items-center gap-3 px-3 py-2 rounded-md border transition-colors cursor-pointer ${d?"border-[var(--accent)] bg-blue-50/50":"border-[var(--border-subtle)] bg-white hover:border-[var(--border-default)]"}`,children:[e.jsx("input",{type:"checkbox",checked:d,onChange:()=>m(t),className:"rounded border-[var(--border-input)] text-[var(--accent)] focus:ring-[var(--accent-focus-ring)]"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("span",{className:"text-[13px] font-medium text-[var(--text-primary)]",children:l.label}),e.jsx("p",{className:"text-[11px] text-[var(--text-muted)] mt-0.5 truncate",children:l.description})]}),e.jsx("span",{className:"text-[11px] text-[var(--text-muted)] whitespace-nowrap",children:l.format})]},t)})})]},v.id)})]})]})}const B=[{id:"global",label:"Global Settings",icon:e.jsx(fe,{}),defaultTab:"global",tabs:[{id:"global",label:"General",description:"Configure team-wide parameters and defaults"},{id:"kpi-cards",label:"KPI Cards",description:"Choose which KPI cards appear on the dashboard, apply presets, and reorder"},{id:"narrative-summary",label:"Narrative Summary",description:"Configure the monthly narrative observations, tone, and framing"},{id:"alert-rules",label:"Alert Rules",description:"Configure anomaly detection thresholds and severity levels"}]},{id:"project",label:"Project Settings",icon:e.jsx(je,{}),defaultTab:"projects",tabs:[{id:"projects",label:"Projects",description:"Manage project registry and classifications"},{id:"milestones",label:"Milestones",description:"Configure gate review dates for NPD projects"},{id:"planned-hours",label:"Planned Hours",description:"Set monthly hour budgets for each project"}]},{id:"team",label:"Team Settings",icon:e.jsx(ye,{}),defaultTab:"team",tabs:[{id:"team",label:"Team Members",description:"Manage team roster and role assignments"},{id:"skills",label:"Skills Matrix",description:"Rate engineer skills on a 0-5 scale"},{id:"allocations",label:"Resource Allocations",description:"Assign engineers to projects with allocation percentages"}]}],G=B.flatMap(i=>i.tabs),ge=new Set(G.map(i=>i.id));function V(i){return B.find(g=>g.tabs.some(N=>N.id===i))?.id??"global"}function De(){const[i]=X(),g=i.get("tab"),N=g&&ge.has(g)?g:"global",[j,n]=k.useState(N),[o,r]=k.useState(V(N)),m=G.find(p=>p.id===j),c=p=>{o===p.id||r(p.id),n(p.defaultTab)},u=p=>{n(p),r(V(p))};return e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-bold text-[var(--text-primary)] mb-5",children:"Configuration"}),e.jsxs("div",{className:"flex gap-0 bg-[var(--bg-panel)] border border-[var(--border-default)] rounded-lg overflow-hidden min-h-[600px]",children:[e.jsx("div",{className:"w-[220px] flex-shrink-0 border-r border-[var(--border-default)] bg-[var(--bg-table-header)]",children:e.jsx("nav",{className:"py-1",children:B.map(p=>{const f=o===p.id,h=p.tabs.some(y=>y.id===j);return e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>c(p),className:`
                      w-full text-left px-3 py-2.5 text-[12px] font-semibold uppercase tracking-[0.04em] transition-colors
                      flex items-center gap-2
                      ${h?"text-[var(--accent)]":"text-[var(--text-muted)] hover:text-[var(--text-secondary)]"}
                    `,children:[e.jsx("span",{className:"flex-shrink-0 w-4 h-4",children:p.icon}),e.jsx("span",{className:"flex-1",children:p.label}),e.jsx("svg",{className:`w-3 h-3 flex-shrink-0 transition-transform duration-150 ${f?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),e.jsx("div",{className:`overflow-hidden transition-all duration-150 ${f?"max-h-[300px] opacity-100":"max-h-0 opacity-0"}`,children:p.tabs.map(y=>e.jsx("button",{onClick:()=>u(y.id),className:`
                          w-full text-left pl-9 pr-3 py-2 text-[13px] transition-colors
                          border-l-[3px]
                          ${j===y.id?"border-l-[var(--accent)] text-[var(--accent)] bg-white font-semibold":"border-l-transparent text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-white/60 font-medium"}
                        `,children:y.label},y.id))}),e.jsx("div",{className:"mx-3 border-b border-[var(--border-subtle)]"})]},p.id)})})}),e.jsxs("div",{className:"flex-1 p-6 overflow-y-auto",children:[e.jsx("h2",{className:"text-lg font-bold text-[var(--text-primary)] mb-1",children:m.label}),e.jsx("p",{className:"text-[13px] text-[var(--text-muted)] mb-6",children:m.description}),j==="global"&&e.jsx(ae,{}),j==="team"&&e.jsx(ne,{}),j==="projects"&&e.jsx(de,{}),j==="skills"&&e.jsx(ce,{}),j==="milestones"&&e.jsx(xe,{}),j==="planned-hours"&&e.jsx(pe,{}),j==="allocations"&&e.jsx(ue,{}),j==="alert-rules"&&e.jsx(he,{}),j==="narrative-summary"&&e.jsx(ve,{}),j==="kpi-cards"&&e.jsx(be,{})]})]})]})}function fe(){return e.jsxs("svg",{fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",strokeWidth:1.5,children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7 7 0 010 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.248a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a7 7 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.282c-.062-.373-.312-.686-.644-.87a7 7 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.248a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.991a7 7 0 010-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 01-.26-1.43l1.297-2.248a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})]})}function je(){return e.jsx("svg",{fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",strokeWidth:1.5,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z"})})}function ye(){return e.jsx("svg",{fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",strokeWidth:1.5,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z"})})}export{De as ConfigPage};
